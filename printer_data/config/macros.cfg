# This file provides examples of Klipper G-Code macros.  The snippets
# in this file may be copied into the main printer.cfg file and
# customized.

# See docs/Config_Reference.md for a description of parameters.


######################################################################
# Start Print and End Print
######################################################################

# Replace the slicer's custom start and end g-code scripts with
# START_PRINT and END_PRINT. See docs/Slicers.md for more information on using these macros.

# [gcode_macro PRINT_START]
# gcode:
#     {% set BED_TEMP=params.BED_TEMP|default(60)|float %}
#     {% set EXTRUDER_TEMP=params.EXTRUDER_TEMP|default(240)|float %}

#     # Preheat the bed
#     M140 S{BED_TEMP}
#     M190 S{BED_TEMP}
#     M104 S240
#     # M83 ; extruder relative mode
#     # M104 S150 ; set temporary nozzle temp to prevent oozing during homing
#     # G4 S10 ; allow partial nozzle warmup

#     # Home the printer
#     G90
#     G28
#     G92 E0 ; reset extrusion distance

#     # Z probing sequence
#     BED_MESH_PROFILE LOAD="default"

#     # Prime line start position
#     G1 Z5 F3000 ; lift
#     G1 X5 Y5 F1500 ; move to prime position
#     G1 Z0.15 F3000 ; get ready to prime

#     # Heat the extruder to the desired temperature
#     M109 S{EXTRUDER_TEMP}

#     # Prime line sequence
#     G1 X150 E30 F600 ; prime nozzle with adjusted extrusion / E__ based on how much you like

#     # String removal circle after priming
#     G1 Z0.2 F3000 ; adjust to 0.2mm above the bed
#     G1 Y5 F10000 ; move the toolhead in the Y direction by 5 units

[gcode_macro SET_PRINT_AREA]
description: Store print area for adaptive bed mesh
variable_bed_min_x: 0
variable_bed_min_y: 0
variable_bed_max_x: 0
variable_bed_max_y: 0
gcode:
    {% set minx = params.BBOX_MIN.split(",")[0]|float %}
    {% set miny = params.BBOX_MIN.split(",")[1]|float %}
    {% set maxx = params.BBOX_MAX.split(",")[0]|float %}
    {% set maxy = params.BBOX_MAX.split(",")[1]|float %}

    SET_GCODE_VARIABLE MACRO=SET_PRINT_AREA VARIABLE=bed_min_x VALUE={minx}
    SET_GCODE_VARIABLE MACRO=SET_PRINT_AREA VARIABLE=bed_min_y VALUE={miny}
    SET_GCODE_VARIABLE MACRO=SET_PRINT_AREA VARIABLE=bed_max_x VALUE={maxx}
    SET_GCODE_VARIABLE MACRO=SET_PRINT_AREA VARIABLE=bed_max_y VALUE={maxy}

    RESPOND TYPE=echo MSG="Adaptive area set: X={minx}-{maxx}, Y={miny}-{maxy}"

[gcode_macro PRINT_START]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(70)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(240)|float %}

    # ============================================================
    #                ПІДГОТОВКА ТА РОЗІГРІВ
    # ============================================================

    # Почати гріти стіл, але не чекати
    M140 S{BED_TEMP}

    # Почати нагрів сопла до анти-ooze
    M104 S170

    # ==========================================
    # ХОМИНГ
    # ==========================================
    G90
    G28

    # ==========================================
    # Очікування температури столу
    # ==========================================
    RESPOND TYPE=echo MSG="Waiting for bed stability..."
    M190 S{BED_TEMP}

    # Зробити паузу 30–60 сек для стабілізації
    G4 S45
    RESPOND TYPE=echo MSG="Bed stabilized."

    # ============================================================
    #                АДАПТИВНИЙ BED MESH
    # ============================================================

    {% set minx = printer["gcode_macro SET_PRINT_AREA"].bed_min_x %}
    {% set miny = printer["gcode_macro SET_PRINT_AREA"].bed_min_y %}
    {% set maxx = printer["gcode_macro SET_PRINT_AREA"].bed_max_x %}
    {% set maxy = printer["gcode_macro SET_PRINT_AREA"].bed_max_y %}

    RESPOND TYPE=echo MSG="Adaptive mesh area: X={minx}-{maxx}, Y={miny}-{maxy}"

    # Паркуємо сопло у початок друкованої області, а не у лівий передній кут
    G1 X{minx + 5} Y{miny + 5} Z5 F6000

    # Запуск адаптивного мешу
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE ADAPTIVE=1

    # ============================================================
    #         ДОГРІВАЄМО СОПЛО ДО РОБОЧОЇ ТЕМПЕРАТУРИ
    # ============================================================
    M104 S{EXTRUDER_TEMP}
    M109 S{EXTRUDER_TEMP}

    RESPOND TYPE=echo MSG="Extruder ready. Starting prime line."

    # ============================================================
    #         PRIME LINE
    # ============================================================
    G92 E0
    G1 Z0.3 F3000
    G1 X{minx + 5} Y{miny + 5} F6000
    G1 X{minx + 50} E12 F600

    G92 E0

    RESPOND TYPE=echo MSG="Print start sequence done."

[gcode_macro PRINT_END]
gcode:
    # Turn off bed, extruder, and fan
    M140 S0
    M104 S0
    M106 S0
    # Move nozzle away from print while retracting
    G91
    G1 X-2 Y-2 E-3 F300
    # Raise nozzle by 10mm
    G1 Z10 F3000
    G90
    G92 E0 ;(resets the extruder)
    G1 Y200 F2500 ;(moves the extruder to Y200 - bringing the bed forward)
    # Disable steppers
    M84

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
    # Turn off bed, extruder, and fan
    M140 S0
    M104 S0
    M106 S0
    # Move nozzle away from print while retracting
    G91
    G1 X-2 Y-2 E-3 F300
    # Raise nozzle by 10mm
    G1 Z10 F3000
    G90
    G92 E0 ;(resets the extruder)
    G1 Y200 F2500 ;(moves the extruder to Y200 - bringing the bed forward)
    # Disable steppers
    M84

[gcode_macro CLEAR_BED]
gcode:
    G92 E0
    G92 E0
    G1 F1500 E-10
    G0 F4000 X115 Y115
    G0 Z50
    G0 F4000 Y0 
    G0 F4000 Y235
    G1 Z1
    G1 X87.561 Y25.547
    G92 E0
    G92 E0
    G1 F1500 E10
    G92 E0
    G92 E0
    G1 Z.2 F9000

######################################################################
# Filament Change
######################################################################

# M600: Filament Change. This macro will pause the printer, move the
# tool to the change position, and retract the filament 50mm. Adjust
# the retraction settings for your own extruder. After filament has
# been changed, the print can be resumed from its previous position
# with the "RESUME" gcode.

[idle_timeout]
gcode:
  {% if printer.pause_resume.is_paused %}
  {% set TARGET_TEMP = params.TARGET | default(220) | float %}
  SET_GCODE_VARIABLE MACRO=IDLE_TIMEOUT VARIABLE=temp_target VALUE={ TARGET_TEMP }
  M117 Idle but paused, maintaining bed temp.
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
  {% else %}
  TURN_OFF_HEATERS
  M84
  {% endif %}
#   A list of G-Code commands to execute on an idle timeout. See
#   docs/Command_Templates.md for G-Code format. The default is to run
#   "TURN_OFF_HEATERS" and "M84".
timeout: 86400
#   Idle time (in seconds) to wait before running the above G-Code
#   commands. The default is 600 seconds.

[pause_resume]

[gcode_macro M600]
gcode:
    {% set X = params.X|default(50)|float %}
    {% set Y = params.Y|default(0)|float %}
    {% set Z = params.Z|default(10)|float %}
    SAVE_GCODE_STATE NAME=M600_state
    PAUSE
    G91
    G1 E-.8 F2700
    G1 Z{Z}
    G90
    G1 X{X} Y{Y} F3000
    G91
    G1 E-50 F1000
    RESTORE_GCODE_STATE NAME=M600_state

# SDCard 'looping' (aka Marlin M808 commands) support
#
# Support SDCard looping
[sdcard_loop]

# 'Marlin' style M808 compatibility macro for SDCard looping
[gcode_macro M808]
gcode:
    {% if params.K is not defined and params.L is defined %}SDCARD_LOOP_BEGIN COUNT={params.L|int}{% endif %}
    {% if params.K is not defined and params.L is not defined %}SDCARD_LOOP_END{% endif %}
    {% if params.K is defined and params.L is not defined %}SDCARD_LOOP_DESIST{% endif %}

# Cancel object (aka Marlin/RRF M486 commands) support
#
# Enable object exclusion
[exclude_object]

[gcode_macro M486]
gcode:
  # Parameters known to M486 are as follows:
  #   [C<flag>] Cancel the current object
  #   [P<index>] Cancel the object with the given index
  #   [S<index>] Set the index of the current object.
  #       If the object with the given index has been canceled, this will cause
  #       the firmware to skip to the next object. The value -1 is used to
  #       indicate something that isn’t an object and shouldn’t be skipped.
  #   [T<count>] Reset the state and set the number of objects
  #   [U<index>] Un-cancel the object with the given index. This command will be
  #       ignored if the object has already been skipped

  {% if 'exclude_object' not in printer %}
    {action_raise_error("[exclude_object] is not enabled")}
  {% endif %}

  {% if 'T' in params %}
    EXCLUDE_OBJECT RESET=1

    {% for i in range(params.T | int) %}
      EXCLUDE_OBJECT_DEFINE NAME={i}
    {% endfor %}
  {% endif %}

  {% if 'C' in params %}
    EXCLUDE_OBJECT CURRENT=1
  {% endif %}

  {% if 'P' in params %}
    EXCLUDE_OBJECT NAME={params.P}
  {% endif %}

  {% if 'S' in params %}
    {% if params.S == '-1' %}
      {% if printer.exclude_object.current_object %}
        EXCLUDE_OBJECT_END NAME={printer.exclude_object.current_object}
      {% endif %}
    {% else %}
      EXCLUDE_OBJECT_START NAME={params.S}
    {% endif %}
  {% endif %}

  {% if 'U' in params %}
    EXCLUDE_OBJECT RESET=1 NAME={params.U}
  {% endif %}

[gcode_macro TEST_SPEED]
# Home, get position, throw around toolhead, home again.
# If MCU stepper positions (first line in GET_POSITION) are greater than a full step different (your number of microsteps), then skipping occured.
# We only measure to a full step to accomodate for endstop variance.
# Example: TEST_SPEED SPEED=300 ACCEL=5000 ITERATIONS=10

description: Test for max speed and acceleration parameters for the printer. Procedure: Home -> ReadPositionFromMCU -> MovesToolhead@Vel&Accel -> Home -> ReadPositionfromMCU

gcode:
    # Speed
    {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    # Iterations
    {% set iterations = params.ITERATIONS|default(5)|int %}
    # Acceleration
    {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    # Minimum Cruise Ratio
    {% set min_cruise_ratio = params.MIN_CRUISE_RATIO|default(0.5)|float %}
    # Bounding inset for large pattern (helps prevent slamming the toolhead into the sides after small skips, and helps to account for machines with imperfectly set dimensions)
    {% set bound = params.BOUND|default(20)|int %}
    # Size for small pattern box
    {% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
    
    # Large pattern
        # Max positions, inset by BOUND
        {% set x_min = printer.toolhead.axis_minimum.x + bound %}
        {% set x_max = printer.toolhead.axis_maximum.x - bound %}
        {% set y_min = printer.toolhead.axis_minimum.y + bound %}
        {% set y_max = printer.toolhead.axis_maximum.y - bound %}
    
    # Small pattern at center
        # Find X/Y center point
        {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
        {% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
        
        # Set small pattern box around center point
        {% set x_center_min = x_center - (smallpatternsize/2) %}
        {% set x_center_max = x_center + (smallpatternsize/2) %}
        {% set y_center_min = y_center - (smallpatternsize/2) %}
        {% set y_center_max = y_center + (smallpatternsize/2) %}

    # Save current gcode state (absolute/relative, etc)
    SAVE_GCODE_STATE NAME=TEST_SPEED
    
    # Output parameters to g-code terminal
    { action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
    
    # Home and get position for comparison later:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28
        # QGL if not already QGLd (only if QGL section exists in config)
        {% if printer.configfile.settings.quad_gantry_level %}
            {% if printer.quad_gantry_level.applied == False %}
                QUAD_GANTRY_LEVEL
                G28 Z
            {% endif %}
        {% endif %} 
        # Move 50mm away from max position and home again (to help with hall effect endstop accuracy - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/24)
        G90
        G1 X{printer.toolhead.axis_maximum.x-50} Y{printer.toolhead.axis_maximum.y-50} F{30*60}
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 X Y
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Go to starting position
    G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60}

    # Set new limits
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} MINIMUM_CRUISE_RATIO={min_cruise_ratio}
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
    {% endif %}

    {% for i in range(iterations) %}
        # Large pattern diagonals
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        
        # Large pattern box
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
    
        # Small pattern diagonals
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        
        # Small pattern box
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
    {% endfor %}

    # Restore max speed/accel/accel_to_decel to their configured values
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio} 
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
    {% endif %}

    # Re-home and get position again for comparison:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 # This is a full G28 to fix an issue with CoreXZ - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/12
        # Go to XY home positions (in case your homing override leaves it elsewhere)
        G90
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Restore previous gcode state (absolute/relative, etc)
    RESTORE_GCODE_STATE NAME=TEST_SPEED

######################################################################
# BED LEVELING
######################################################################

[screws_tilt_adjust]
screw1: 70,36
screw1_name: front left screw
screw2: 240,36
screw2_name: front right screw
screw3: 240,206 
screw3_name: rear right screw 
screw4: 70,206
screw4_name: rear left screw
horizontal_move_z: 10
speed: 50
screw_thread: CW-M3 #measure the diameter of your adjustment screw