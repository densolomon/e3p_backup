[gcode_macro SET_PRINT_AREA]
description: Store print area for adaptive bed mesh
variable_bed_min_x: 0
variable_bed_min_y: 0
variable_bed_max_x: 0
variable_bed_max_y: 0
gcode:
    {% set minx = params.BBOX_MIN.split(",")[0]|float %}
    {% set miny = params.BBOX_MIN.split(",")[1]|float %}
    {% set maxx = params.BBOX_MAX.split(",")[0]|float %}
    {% set maxy = params.BBOX_MAX.split(",")[1]|float %}

    SET_GCODE_VARIABLE MACRO=SET_PRINT_AREA VARIABLE=bed_min_x VALUE={minx}
    SET_GCODE_VARIABLE MACRO=SET_PRINT_AREA VARIABLE=bed_min_y VALUE={miny}
    SET_GCODE_VARIABLE MACRO=SET_PRINT_AREA VARIABLE=bed_max_x VALUE={maxx}
    SET_GCODE_VARIABLE MACRO=SET_PRINT_AREA VARIABLE=bed_max_y VALUE={maxy}

    RESPOND TYPE=note MSG="Adaptive area set: X={minx}-{maxx}, Y={miny}-{maxy}

[gcode_macro PRINT_START]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(70)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(240)|float %}

    # ============================================================
    #                ПІДГОТОВКА ТА РОЗІГРІВ
    # ============================================================

    # Почати гріти стіл, але не чекати
    M140 S{BED_TEMP}

    # Почати нагрів сопла до анти-ooze
    M104 S170

    # ==========================================
    # ХОМИНГ
    # ==========================================
    G90
    G28

    # ==========================================
    # Очікування температури столу
    # ==========================================
    RESPOND TYPE=note MSG="Waiting for bed stability..."
    M190 S{BED_TEMP}

    # Зробити паузу 30–60 сек для стабілізації
    G4 S45
    RESPOND TYPE=note MSG="Bed stabilized."

    # ============================================================
    #                АДАПТИВНИЙ BED MESH
    # ============================================================

    {% set minx = printer["gcode_macro SET_PRINT_AREA"].bed_min_x %}
    {% set miny = printer["gcode_macro SET_PRINT_AREA"].bed_min_y %}
    {% set maxx = printer["gcode_macro SET_PRINT_AREA"].bed_max_x %}
    {% set maxy = printer["gcode_macro SET_PRINT_AREA"].bed_max_y %}

    RESPOND TYPE=note MSG="Adaptive mesh area: X={minx}-{maxx}, Y={miny}-{maxy}"

    # Паркуємо сопло у початок друкованої області, а не у лівий передній кут
    G1 X{minx + 5} Y{miny + 5} Z5 F6000

    # Запуск адаптивного мешу
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE ADAPTIVE=1

    # ============================================================
    #         ДОГРІВАЄМО СОПЛО ДО РОБОЧОЇ ТЕМПЕРАТУРИ
    # ============================================================
    M104 S{EXTRUDER_TEMP}
    M109 S{EXTRUDER_TEMP}

    RESPOND TYPE=note MSG="Extruder ready. Starting prime line."

    # ============================================================
    #         PRIME LINE
    # ============================================================
    G92 E0
    G1 Z0.3 F3000
    G1 X{minx + 5} Y{miny + 5} F6000
    G1 X{minx + 50} E12 F600

    G92 E0

    RESPOND TYPE=note MSG="Print start sequence done."
